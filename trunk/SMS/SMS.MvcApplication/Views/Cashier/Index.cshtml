@using SMS.MvcApplication.Models
@using SMS.Common.Constant
@model CashierModel
@{
    ViewBag.Title = "Index";
}
<link rel="stylesheet" type="text/css" href="~/Content/css/split-pane.css" />
<script type="text/javascript" src="~/Scripts/split-pane.js"></script>
<script type="text/javascript" src="~/Scripts/jquery.validate.js"></script>
<script type="text/javascript">
    var listProduct = @Html.Raw(Json.Encode(Model.ListProduct))
</script>
<script id="pdt-tmpl" type="text/x-jquery-tmpl">
    <tr>
        <td>${idx}</td>
        <td>${VNName}</td>
        <td class="right">${Quantity}</td>
        <td>${Unit.VNName}</td>
        <td class="right">${Price}</td>
        <td class="right item_subtotal">${Price * Quantity}</td>
        <td>
            <input type="text" name="remarks${No}" class="remarksInput" /></td>
        <td class="center"><a href="#" id="del-${ID}">X</a></td>
    </tr>
</script>
<script id="table-tmpl" type="text/x-jquery-tmpl">
    {{each(idx) ListTable}}
    {{if idx % @ConstStyle.GridNumber == 0}}
    <div class='row'>
        {{/if}}
        <div class="one column">
            <table class="tbls" id="${ID}-${Table.ID}-${Table.VNName}">
                <tr>
                    <td>
                        {{if ID > 0}}
                        <img alt="${Table.VNName}" src="Images/IconControls/table-avai.png" style="height: 45px" />
                        {{else}}
                        <img alt="${Table.VNName}" src="Images/IconControls/table-empty.png" style="height: 45px" />
                        {{/if}}
                    </td>
                </tr>
                <tr>
                    <td>${Table.VNName}</td>
                </tr>
            </table>
        </div>
            
        {{if idx == $data.ListTable.length || idx % @ConstStyle.GridNumber == @ConstStyle.GridNumber - 1}}
        </div>
        {{/if}}
    {{/each}}
</script>

<style>
    .Rmenu {
        position: fixed;
        display: none;
        z-index: 100;
    }
    .Rmenu{
        width:150px;
        list-style:none;
        background:gray;
        border:1px solid #faf5f7;
    }
    .Rmenu li{
        border-top:1px solid #faf5f7;
        position:relative;
    }
    .Rmenu li a{
        color:green;
        text-decoration:none;
        display:block;
        width:100%;height:100%;
        text-indent:20px;
        font-size:10px;
        font-weight:bold;
    }
    .Rmenu li a:hover{
        background:yellow;
    }
    .Rmenu li ul{
        position:absolute;
        top:0;
        left:150px;
        display:none;
    }
    .Rmenu>li:hover ul{
        display:block
    }
</style>

<script id="Rmenu-tmpl" type="text/x-jquery-tmpl">
    {{each(idx) ListTable}}
    <ul id="Rmenu-${ID}-${Table.ID}" class="Rmenu">
        <li><a href="#" id="SelectNew-${ID}-${Table.ID}" onclick="onSelectNewTable(${Table.ID})">Sử dụng ngay</a></li>
        <li><a href="#">In hóa đơn</a></li>
        <li><a href="#">Nhập bàn</a></li>
        <li><a href="#">Tách bàn</a></li>
        <li><a href="#">Chuyển bàn</a></li>
        <li class="RmenuDelete"><a href="#" id="Delete-${ID}-${Table.ID}" onclick="onClearInvoiceTable(${ID})">Xóa thông tin</a></li>
    </ul>
    {{/each}}
</script>

<div id="cashier" class="split-pane horizontal-percent">
    <div id="area-table" class="split-pane-component">
        <ul id="areas">
            @foreach (var areaDto in Model.ListArea)
            {
                <li><a href="#area-@areaDto.ID" onclick="GetTablesByAreaID(@areaDto.ID)">@areaDto.VNName</a></li>
            }

        </ul>
        <div id="tables">
            @foreach (var areaDto in Model.ListArea)
            {
                <div id="area-@areaDto.ID">
                </div>
            }
        </div>
    </div>

    <div class="split-pane-divider"></div>

    <div id="tableorder" class="split-pane-component">
        <div class="row">
            <div class="two columns">Table name</div>
            <div class="four columns">User: Son Nguyen. Date: 11/04/2014 18:00</div>
        </div>
        <div class="row">
            <table id="order">
                <colgroup>
                    <col class="col1" />
                    <col class="col2" />
                    <col class="col3" />
                    <col class="col4" />
                    <col class="col5" />
                    <col class="col6" />
                    <col class="col7" />
                    <col class="col8" />
                </colgroup>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Price</th>
                        <th>Amount</th>
                        <th>Remarks</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody class="tbContent">
                    @*<tr>
                        <td>1</td>
                        <td>Cơm gà</td>
                        <td class="right">1</td>
                        <td>Đĩa</td>
                        <td class="right">20.000</td>
                        <td class="right">20.000</td>
                        <td>
                            <input type="text" name="remarks1" class="remarksInput" /></td>
                        <td class="center">X</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Lẩu bò</td>
                        <td class="right">1</td>
                        <td>Cái</td>
                        <td class="right">120.000</td>
                        <td class="right">120.000</td>
                        <td>
                            <input type="text" name="remarks2" class="remarksInput" /></td>
                        <td class="center">X</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Đũa</td>
                        <td class="right">3</td>
                        <td>Đôi</td>
                        <td class="right">5.000</td>
                        <td class="right">15.000</td>
                        <td>
                            <input type="text" name="remarks3" class="remarksInput" /></td>
                        <td class="center">X</td>
                    </tr>*@
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="8"><a href="#" id="addProduct">+</a></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div id="totalSection">
            <div class="row">
                <div class="two columns push_eight right">Total:</div>
                <div class="two columns right"><span class="total_amount">0</span> VNĐ</div>
            </div>
            <div class="row">
                <div class="two columns push_eight right">Service Fee:</div>
                <div class="two columns right"><span class="fee">0</span> VNĐ</div>
            </div>
            <div class="row">
                <div class="two columns push_eight right">Tax (10%):</div>
                <div class="two columns right"><span class="tax">0</span> VNĐ</div>
            </div>
            <div class="row">
                <div class="two columns push_eight right">Total Amount:</div>
                <div class="two columns right border-top"><span class="total_money">0</span> VNĐ</div>
            </div>
        </div>
    </div>

    @Html.Partial("_SearchProductPopup", new PopupModel { PopupID = "pdtPopup", PopupTitle = "Search Product" })

    <script type="text/javascript">
        $(document).ready(function () {
            $('div.split-pane').splitPane();
            $('#area-table').tabs();
            $("#addProduct").hide();
            $("#addProduct").click(function () {
                var product = new SearchProductPopup("pdtPopup", listProduct, onRefreshProduct, onSelectProduct, onDeleteProduct);
                product.OpenPopup();
                return false;
            });

            var area = $('#areas li.ui-tabs-selected a[href*="area-"]').attr('href');
            var id = area.split('-')[1];
            GetTablesByAreaID(id);
        });

        function onClearInvoiceTable(invTblId) {
            $.ajax({
                type: 'POST',
                url: '/Cashier/DeleteInvoiceTable',
                data: { invoiceTableID: invTblId }
            }).done(function (data) {
                if (data == true)
                    alert('Susscess');
                else
                    alert('Fail');
                        
                var area = $('#areas li.ui-tabs-selected a[href*="area-"]').attr('href');
                var areaId = area.split('-')[1];
                GetTablesByAreaID(areaId);
                $("#addProduct").hide();
            });
        }

        //$(document).on("click", ".tbls", (function() {
        //    alert( "Handler for .click() called." );
        //}));
        
        $(document).on("dblclick", ".tbls", (function(e) {
            var invTblId = $(e.target).parents('.tbls').attr('id').split('-')[0];
            var tblId = $(e.target).parents('.tbls').attr('id').split('-')[1];
            if(invTblId == 0) {
                var didConfirm = confirm("Bàn này hiện đang trống. \nSử dụng ngay?");
                if (didConfirm == true) {
                    invTblId = onSelectNewTable(tblId);
                }
                else {
                    return false;
                }
            }
            onSelectTable(invTblId);
        }));
        
        //$(document).on("contextmenu", "#area-table", function(e) {
        //    return false;
        //});
        
        $(document).on("contextmenu", ".tbls", function(e){
            var invTblId = $(e.target).parents('.tbls').attr('id').split('-')[0];
            var tblId = $(e.target).parents('.tbls').attr('id').split('-')[1];
            var $menu = $('#Rmenu-' + invTblId + '-' + tblId);
            var $wMenu = $menu.outerWidth();
            var $hMenu = $menu.outerHeight();
            var $leftM = e.clientX, $topM = e.clientY;
            var $rightM = $(window).width() - $leftM;
      
            var $bottomM = $(window).height()-$topM;
            if($rightM < $wMenu){
                $leftM -= $wMenu;
            }
            if($bottomM < $hMenu){
                $topM -= $hMenu;
            }
            $menu.css({left: $leftM, top: $topM, display:'block'});
            e.preventDefault();
        });
        
        $(document).click(function() {
            $("ul[id*=Rmenu-]").hide();
        });

        function onSelectTable(invTblId) {
            $.ajax({
                type: 'POST',
                url: '/Cashier/SelectTable',
                data: { invoiceTableID: invTblId }
            }).done(function (data) {
                $('#order .tbContent').html('');
                $(data).each(function(idx) {
                    data[idx].idx = idx + 1;
                });
                
                $('#pdt-tmpl').tmpl(data).appendTo('#order .tbContent');
                CalculateTotal();
            });
            $("#addProduct").show();
        }
        
        function onSelectNewTable(tblId) {
            var invTblId = 0;
            $.ajax({
                type: 'POST',
                url: '/Cashier/SelectNewTable',
                data: { tableID: tblId }
            }).done(function (data) {
                invTblId = data.ID;
                        
                var area = $('#areas li.ui-tabs-selected a[href*="area-"]').attr('href');
                var id = area.split('-')[1];
                GetTablesByAreaID(id);
            });
            $("#addProduct").show();
            return invTblId;
        }

        function onRefreshProduct(reloadCallback) {
            $.ajax({
                type: 'POST',
                url: '/Cashier/GetAllProductsForSearch',
            }).done(function (data) {
                listProduct = data;
            });
            
            if(reloadCallback)
                reloadCallback(listProduct);
        }

        function onSelectProduct(pdtId, qty) {
            $.ajax({
                type: 'POST',
                url: '/Cashier/SelectProduct',
                data: { productID: pdtId, quantity: qty }
            }).done(function (data) {
                var count = $('#order .tbContent tr').length;
                data.idx = count + 1;

                $('#pdt-tmpl').tmpl(data).appendTo('#order .tbContent');
                CalculateTotal();
            });
        }

        function onDeleteProduct(pdtId) {
            return false;
        }

        function GetTablesByAreaID(areaID) {
            $.ajax({
                type: 'POST',
                url: '/Cashier/GetTablesByAreaID',
                data: { areaID: areaID }
            }).done(function (data) {
                $('#area-' + areaID).html('');
                $('#table-tmpl').tmpl(data).appendTo('#area-' + areaID);
                $('#Rmenu-tmpl').tmpl(data).appendTo('#body');
            });
        }
        
        function CalculateTotal() {
            var totalAmount = 0;
            $('#order .tbContent tr').each(function (idx, element) {
                totalAmount += parseInt($(element).find('td.item_subtotal').text());
            });
            $('#totalSection .total_amount').text(totalAmount);
            
            var tax = totalAmount / 10;
            $('#totalSection .tax').text(tax);
            
            $('#totalSection .total_money').text(totalAmount + tax);
        }
    </script>
</div>
